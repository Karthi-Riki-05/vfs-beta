FROM node:20-alpine

# 1. Install libc6-compat (required for Next.js on Alpine)
RUN apk add --no-cache libc6-compat
WORKDIR /app

# 2. Pre-create the folder and set permissions to the 'node' user
RUN mkdir -p /app/node_modules && chown -R node:node /app

# 3. Use the 'node' user for all following steps
USER node

# 4. Copy package files and install
COPY --chown=node:node package*.json ./
RUN npm install

# 5. Copy the rest of the code
COPY --chown=node:node . .

EXPOSE 3000
ENV NODE_ENV=development

CMD ["npm", "run", "dev", "--", "-H", "0.0.0.0"]